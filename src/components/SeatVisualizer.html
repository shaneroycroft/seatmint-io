<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>SeatMint | Venue Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        :root {
            --font-main: 'Inter', sans-serif;
            --brand-600: #2563eb;
            --brand-700: #1d4ed8;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            overflow: hidden;
            font-family: var(--font-main);
            background: #0f172a;
            color: #f8fafc;
            user-select: none;
            touch-action: none;
        }

        canvas {
            display: block;
            background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
        }

        /* Smooth scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Sidebar */
        .sidebar {
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            z-index: 50;
            width: 340px;
            position: fixed;
            height: 100%;
            top: 0;
            left: 0;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 4px 0 24px -4px rgba(0, 0, 0, 0.08);
            color: #0f172a;
            display: flex;
            flex-direction: column;
        }
        .sidebar.collapsed { transform: translateX(-340px); }

        .sidebar-toggle {
            position: absolute;
            right: -48px;
            top: 24px;
            width: 48px;
            height: 48px;
            background: white;
            border: 1px solid #e2e8f0;
            border-left: none;
            border-radius: 0 12px 12px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #64748b;
            transition: all 0.2s;
            box-shadow: 4px 2px 8px -2px rgba(0, 0, 0, 0.06);
        }
        .sidebar-toggle:hover {
            background: #f8fafc;
            color: #2563eb;
        }
        .sidebar-toggle:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        /* Buy Panel */
        #buy-panel {
            position: fixed;
            inset-y: 0;
            right: 0;
            width: 420px;
            max-width: 100vw;
            background: white;
            box-shadow: -8px 0 32px -8px rgba(0, 0, 0, 0.15);
            z-index: 60;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            color: #0f172a;
        }
        #buy-panel.visible { transform: translateX(0); }

        /* Floating Controls */
        .floating-controls {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 16px;
            z-index: 70;
            pointer-events: auto;
        }

        .control-group {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            padding: 6px;
            border-radius: 16px;
            display: flex;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.3);
        }

        .control-btn {
            padding: 10px 24px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s;
            color: #94a3b8;
            border: none;
            background: transparent;
        }
        .control-btn:hover:not(.active) {
            color: #e2e8f0;
            background: rgba(255, 255, 255, 0.05);
        }
        .control-btn.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 16px -2px rgba(37, 99, 235, 0.5);
        }
        .control-btn:focus-visible {
            outline: 2px solid #60a5fa;
            outline-offset: 2px;
        }

        /* Tooltip */
        #seat-tooltip {
            position: absolute;
            pointer-events: none;
            opacity: 0;
            background: rgba(15, 23, 42, 0.97);
            color: white;
            padding: 14px 18px;
            border-radius: 14px;
            font-size: 13px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
            transform: translate(-50%, -150%);
            transition: opacity 0.15s, transform 0.15s;
            box-shadow: 0 16px 48px -8px rgba(0, 0, 0, 0.4);
            min-width: 160px;
        }
        #seat-tooltip.visible {
            opacity: 1;
            transform: translate(-50%, -140%);
        }

        /* Marker Labels */
        .marker-label {
            position: absolute;
            background: #0f172a;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 800;
            pointer-events: none;
            transform: translate(-50%, -150%);
            opacity: 0;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.3);
        }
        .marker-label.visible {
            opacity: 1;
            transform: translate(-50%, -170%);
        }

        /* Form Elements */
        .config-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        .config-card:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 8px -2px rgba(0, 0, 0, 0.06);
        }

        .section-label {
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin: 24px 0 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-label:first-child { margin-top: 0; }

        .add-btn {
            color: #2563eb;
            font-weight: 700;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
            transition: all 0.15s;
            cursor: pointer;
            background: transparent;
            border: none;
        }
        .add-btn:hover {
            background: #eff6ff;
        }
        .add-btn:focus-visible {
            outline: 2px solid #2563eb;
            outline-offset: 2px;
        }

        input[type=range] {
            accent-color: #2563eb;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            appearance: none;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            box-shadow: 0 2px 6px -1px rgba(37, 99, 235, 0.4);
            transition: transform 0.15s;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        select {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 13px;
            width: 100%;
            font-weight: 600;
            outline: none;
            background: white;
            cursor: pointer;
            transition: all 0.15s;
        }
        select:hover { border-color: #cbd5e1; }
        select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .text-input {
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 13px;
            font-weight: 700;
            background: transparent;
            outline: none;
            transition: all 0.15s;
            color: #0f172a;
        }
        .text-input:hover { background: #f1f5f9; }
        .text-input:focus {
            background: white;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Onboarding Hint */
        .hint-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .hint-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .hint-card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 24px 64px -16px rgba(0, 0, 0, 0.3);
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .hint-overlay.visible .hint-card {
            transform: scale(1);
        }

        /* Keyboard shortcut hints */
        kbd {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 700;
            color: #64748b;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-family: inherit;
        }

        /* Animation keyframes */
        @keyframes pulse-ring {
            0% { transform: scale(0.9); opacity: 1; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        .pulse-ring::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid currentColor;
            animation: pulse-ring 1.5s ease-out infinite;
        }
    </style>
</head>
<body>
    <!-- Seat Tooltip -->
    <div id="seat-tooltip">
        <div id="tt-header" class="text-[10px] uppercase text-blue-400 font-bold tracking-widest mb-1.5">SECTION</div>
        <div id="tt-label" class="text-base font-bold leading-tight mb-1">Row A - Seat 1</div>
        <div id="tt-price" class="text-sm text-slate-400 font-semibold">45 ADA</div>
        <div class="mt-2 pt-2 border-t border-slate-700 text-[10px] text-slate-500">Click to select</div>
    </div>

    <!-- Status Badge (top right) -->
    <div class="fixed top-6 right-6 z-40 bg-white/95 backdrop-blur-md px-5 py-3.5 rounded-2xl border border-slate-200/80 shadow-lg pointer-events-none">
        <div class="flex items-center gap-2.5 mb-1.5">
            <span id="status-dot" class="relative w-2.5 h-2.5 rounded-full bg-blue-600"></span>
            <span class="text-[10px] font-black uppercase tracking-widest text-slate-500" id="status-label">DESIGN MODE</span>
        </div>
        <h2 id="location-label" class="text-lg font-black tracking-tight text-slate-900">Venue Designer</h2>
    </div>

    <!-- Floating Mode Controls -->
    <div class="floating-controls">
        <div class="control-group">
            <button id="tab-design" class="control-btn active" onclick="setAppMode('design')" aria-pressed="true">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                    Design
                </span>
            </button>
            <button id="tab-buy" class="control-btn" onclick="setAppMode('buy')" aria-pressed="false">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    Preview
                </span>
            </button>
        </div>

        <div class="control-group">
            <button id="view-orbit" class="control-btn active" onclick="setViewMode('orbital')" aria-pressed="true">Orbit</button>
            <button id="view-pov" class="control-btn" onclick="setViewMode('pov')" aria-pressed="false">Seat View</button>
        </div>
    </div>

    <!-- Keyboard Hints -->
    <div class="fixed bottom-32 left-1/2 -translate-x-1/2 z-40 flex gap-4 text-slate-400 text-xs pointer-events-none opacity-60">
        <span><kbd>D</kbd> Design</span>
        <span><kbd>P</kbd> Preview</span>
        <span><kbd>O</kbd> Orbit</span>
        <span><kbd>S</kbd> Seat View</span>
    </div>

    <!-- Section Markers Container -->
    <div id="label-container" class="fixed inset-0 pointer-events-none"></div>

    <!-- Buy/Mint Panel (slides from right) -->
    <div id="buy-panel" role="dialog" aria-labelledby="panel-title" aria-modal="true">
        <div class="p-8 pt-6 relative min-h-full flex flex-col">
            <!-- Close Button -->
            <button onclick="closeBuyPanel()" class="absolute top-5 right-5 w-10 h-10 flex items-center justify-center rounded-xl text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition" aria-label="Close panel">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>

            <!-- Header -->
            <div class="text-center mb-8 pt-8">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                </div>
                <h3 id="panel-title" class="text-2xl font-black text-slate-900 mb-2">Confirm Selection</h3>
                <p id="panel-seat-info" class="text-sm font-bold text-slate-500 uppercase tracking-wider">Section - Row - Seat</p>
            </div>

            <!-- Seat Preview -->
            <div class="bg-gradient-to-br from-slate-50 to-slate-100 border border-slate-200 rounded-2xl p-6 mb-6">
                <div class="flex items-center gap-4 mb-4 pb-4 border-b border-slate-200">
                    <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/></svg>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Your Seat</div>
                        <div id="panel-seat-detail" class="text-lg font-black text-slate-900">Orchestra - Row A - Seat 12</div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500 font-medium">Ticket Price</span>
                        <span class="font-bold text-slate-900" id="panel-price">-- ADA</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500 font-medium">Platform Fee</span>
                        <span class="font-semibold text-slate-600">2 ADA</span>
                    </div>
                </div>
            </div>

            <!-- Total -->
            <div class="bg-slate-900 text-white rounded-2xl p-5 mb-8">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-slate-300">Total</span>
                    <span class="text-2xl font-black" id="panel-total">-- ADA</span>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-3 mt-auto">
                <button onclick="closeBuyPanel()" class="flex-1 px-6 py-4 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition focus:outline-none focus:ring-2 focus:ring-slate-300">
                    Cancel
                </button>
                <button onclick="mockMint(); closeBuyPanel()" class="flex-1 px-6 py-4 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-600/25 transition focus:outline-none focus:ring-2 focus:ring-blue-300">
                    Mint Ticket
                </button>
            </div>

            <!-- Info Footer -->
            <p class="text-center text-xs text-slate-400 mt-6">
                This will create an NFT ticket on the Cardano blockchain
            </p>
        </div>
    </div>

    <!-- Design Sidebar -->
    <div id="sidebar" class="sidebar" role="complementary" aria-label="Venue configuration">
        <!-- Toggle Button -->
        <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
            <svg id="chevron" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m15 18-6-6 6-6"/></svg>
        </button>

        <!-- Header -->
        <div class="p-6 pb-4 border-b border-slate-100">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg shadow-blue-600/25">S</div>
                <div>
                    <h1 class="text-lg font-black tracking-tight text-slate-900 leading-none">SeatMint</h1>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Venue Designer</span>
                </div>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6 pt-4">
            <!-- Preset Selector -->
            <section>
                <label class="section-label">Venue Template</label>
                <select id="preset-select" onchange="applyPreset(this.value)" aria-label="Select venue preset">
                    <option value="amphitheater">Amphitheater (Mixed Layout)</option>
                    <option value="stadium">Stadium (Fanned Seating)</option>
                    <option value="club">Club (Rectangular)</option>
                </select>
            </section>

            <!-- Stage Configuration -->
            <section>
                <div class="section-label">Stage</div>
                <div class="config-card">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-slate-600">Width</span>
                        <span id="lbl-sw" class="text-xs font-bold text-blue-600 tabular-nums">30m</span>
                    </div>
                    <input type="range" min="10" max="80" value="30" aria-label="Stage width" oninput="state.stageWidth=parseInt(this.value); document.getElementById('lbl-sw').innerText=this.value+'m'; refreshVenue()">
                </div>
            </section>

            <!-- Sections / Tiers -->
            <section>
                <div class="section-label">
                    <span>Seating Sections</span>
                    <button onclick="addTier()" class="add-btn">+ Add Section</button>
                </div>
                <div id="tier-list"></div>
            </section>

            <!-- Obstructions -->
            <section>
                <div class="section-label">
                    <span>Obstructions</span>
                    <button onclick="addObstruction()" class="add-btn">+ Add Pillar</button>
                </div>
                <div id="obstruction-list"></div>
                <p id="no-obstructions" class="text-xs text-slate-400 text-center py-4">No obstructions added</p>
            </section>
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <button onclick="exportConfig()" class="w-full py-3 px-4 rounded-xl font-bold text-sm text-slate-600 bg-white border border-slate-200 hover:border-slate-300 hover:bg-slate-50 transition flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                Export Configuration
            </button>
        </div>
    </div>

    <!-- First-Time Onboarding Overlay -->
    <div id="hint-overlay" class="hint-overlay">
        <div class="hint-card">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-5">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            </div>
            <h3 class="text-xl font-black text-slate-900 mb-2">Welcome to Venue Designer</h3>
            <p class="text-slate-500 text-sm mb-6 leading-relaxed">
                Design your venue layout with sections, stage, and seating. Switch to <strong>Preview</strong> mode to test the buyer experience.
            </p>
            <div class="flex flex-col gap-3 text-left bg-slate-50 rounded-xl p-4 mb-6">
                <div class="flex items-center gap-3 text-sm">
                    <span class="w-6 h-6 bg-blue-600 text-white rounded-lg flex items-center justify-center text-xs font-bold">1</span>
                    <span class="text-slate-600">Configure sections in the sidebar</span>
                </div>
                <div class="flex items-center gap-3 text-sm">
                    <span class="w-6 h-6 bg-blue-600 text-white rounded-lg flex items-center justify-center text-xs font-bold">2</span>
                    <span class="text-slate-600">Drag to orbit around your venue</span>
                </div>
                <div class="flex items-center gap-3 text-sm">
                    <span class="w-6 h-6 bg-blue-600 text-white rounded-lg flex items-center justify-center text-xs font-bold">3</span>
                    <span class="text-slate-600">Click sections to view from that seat</span>
                </div>
            </div>
            <button onclick="dismissHint()" class="w-full py-4 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 transition shadow-lg shadow-blue-600/25">
                Get Started
            </button>
        </div>
    </div>

    <script>
        // ========================================
        // APPLICATION STATE
        // ========================================
        const state = {
            scene: null,
            camera: null,
            renderer: null,
            raycaster: new THREE.Raycaster(),

            // View modes
            mode: 'orbital',      // 'orbital' | 'pov'
            appMode: 'design',    // 'design' | 'buy'

            // Camera controls
            orbit: { lon: 200, lat: 30, radius: 200 },
            pov: {
                pos: new THREE.Vector3(0, 10, 100),
                lookAt: new THREE.Vector3(0, 4, 0)
            },

            // Pointer state
            mouse: new THREE.Vector2(),
            isDragging: false,
            prevMouse: { x: 0, y: 0 },

            // Seat interaction
            intersectedSeat: { mesh: null, index: null, color: new THREE.Color() },
            selectedSeat: null,

            // Venue configuration
            stageWidth: 30,
            stageHeight: 4,
            markers: [],
            meshes: [],
            obstructions: [],
            tiers: [
                { id: 1, name: "Orchestra", price: 120, depth: 30, width: 80, pitch: 0.04, color: 0x2563eb, layout: 'rectangular' },
                { id: 2, name: "Mezzanine", price: 65, depth: 25, width: 120, pitch: 0.12, color: 0x3b82f6, layout: 'fanned' }
            ]
        };

        // ========================================
        // INITIALIZATION
        // ========================================
        function init() {
            // Scene setup
            state.scene = new THREE.Scene();
            state.scene.background = new THREE.Color(0xf1f5f9);
            state.scene.fog = new THREE.Fog(0xf1f5f9, 250, 1200);

            // Camera
            state.camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.5, 3000);

            // Renderer
            state.renderer = new THREE.WebGLRenderer({ antialias: true });
            state.renderer.setSize(window.innerWidth, window.innerHeight);
            state.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            state.renderer.shadowMap.enabled = true;
            state.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(state.renderer.domElement);

            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.75);
            state.scene.add(ambient);

            const sun = new THREE.DirectionalLight(0xffffff, 0.7);
            sun.position.set(60, 250, 120);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 2048;
            sun.shadow.mapSize.height = 2048;
            sun.shadow.camera.near = 10;
            sun.shadow.camera.far = 500;
            sun.shadow.camera.left = -150;
            sun.shadow.camera.right = 150;
            sun.shadow.camera.top = 150;
            sun.shadow.camera.bottom = -150;
            state.scene.add(sun);

            // Ground plane
            const groundGeo = new THREE.PlaneGeometry(2000, 2000);
            const groundMat = new THREE.MeshStandardMaterial({
                color: 0xe2e8f0,
                roughness: 0.9
            });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            ground.receiveShadow = true;
            state.scene.add(ground);

            // Build venue
            refreshVenue();
            setupEvents();
            animate();
            renderSidebar();

            // Show onboarding if first visit
            if (!localStorage.getItem('seatmint-visited')) {
                setTimeout(() => {
                    document.getElementById('hint-overlay').classList.add('visible');
                }, 500);
            }
        }

        // ========================================
        // VENUE RENDERING
        // ========================================
        function refreshVenue() {
            // Cleanup existing meshes
            state.meshes.forEach(m => state.scene.remove(m));
            state.meshes = [];
            state.scene.children
                .filter(o => o.isMarker || o.isStage || o.isObstruction)
                .forEach(o => state.scene.remove(o));
            state.markers.forEach(m => m.element.remove());
            state.markers = [];

            // Stage
            const stageGeo = new THREE.BoxGeometry(state.stageWidth, state.stageHeight, 22);
            const stageMat = new THREE.MeshStandardMaterial({
                color: 0x1e293b,
                roughness: 0.8,
                metalness: 0.1
            });
            const stage = new THREE.Mesh(stageGeo, stageMat);
            stage.position.set(0, state.stageHeight / 2, 0);
            stage.receiveShadow = true;
            stage.castShadow = true;
            stage.isStage = true;
            state.scene.add(stage);

            // Obstructions
            state.obstructions.forEach(obs => {
                const geo = new THREE.CylinderGeometry(obs.radius, obs.radius, obs.height, 32);
                const mat = new THREE.MeshStandardMaterial({
                    color: 0x475569,
                    roughness: 0.7
                });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(obs.x, obs.height / 2, obs.z);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.isObstruction = true;
                state.scene.add(mesh);
            });

            // Build tiers
            let zStart = 22;
            let baseY = 0.5;

            state.tiers.forEach(tier => {
                const rows = Math.max(1, Math.round(tier.depth / 2.5));
                const cols = Math.max(1, Math.round(tier.width / 4));
                const total = rows * cols;

                // Instanced seats
                const seatGeo = new THREE.BoxGeometry(0.85, 0.55, 0.85);
                const seatMat = new THREE.MeshStandardMaterial({
                    color: tier.color,
                    roughness: 0.7,
                    metalness: 0.05
                });
                const mesh = new THREE.InstancedMesh(seatGeo, seatMat, total);
                mesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.userData = { tier, rows, cols };

                const dummy = new THREE.Object3D();
                const arcRad = THREE.MathUtils.degToRad(tier.width);
                let maxBound = 0;
                let maxY = 0;

                for (let r = 0; r < rows; r++) {
                    const rowY = baseY + (r * tier.pitch * 6);
                    maxY = Math.max(maxY, rowY);

                    for (let c = 0; c < cols; c++) {
                        const i = r * cols + c;
                        const colPct = cols > 1 ? c / (cols - 1) : 0.5;

                        if (tier.layout === 'fanned') {
                            const angle = -arcRad / 2 + colPct * arcRad + Math.PI / 2;
                            const rad = zStart + (r * 2.5);
                            dummy.position.set(Math.cos(angle) * rad, rowY, Math.sin(angle) * rad);
                            dummy.lookAt(0, rowY, 0);
                            maxBound = Math.max(maxBound, rad);
                        } else {
                            const w = tier.width * 0.8;
                            const x = -w / 2 + colPct * w;
                            const z = zStart + (r * 2.5);
                            dummy.position.set(x, rowY, z);
                            dummy.rotation.set(0, 0, 0);
                            maxBound = Math.max(maxBound, Math.sqrt(x * x + z * z));
                        }

                        dummy.updateMatrix();
                        mesh.setMatrixAt(i, dummy.matrix);
                        mesh.setColorAt(i, new THREE.Color(tier.color));
                    }
                }

                mesh.instanceMatrix.needsUpdate = true;
                mesh.instanceColor.needsUpdate = true;
                state.scene.add(mesh);
                state.meshes.push(mesh);

                // Add section marker
                addSectionMarker(
                    new THREE.Vector3(0, maxY + 6, zStart + (rows * 2.5) / 2),
                    tier.name
                );

                zStart = maxBound + 14;
                baseY = maxY + 3;
            });

            // Update obstruction list visibility
            updateObstructionListVisibility();
        }

        function getSeatLabel(tier, r, c, rows, cols) {
            // Row labeling
            const rowLabel = rows <= 3
                ? (r === 0 ? "Front" : r === rows - 1 ? "Rear" : "Middle")
                : `Row ${String.fromCharCode(65 + r)}`; // A, B, C...

            // Seat labeling
            const mid = Math.floor(cols / 2);
            const seatNum = c + 1;
            const seatLabel = `Seat ${seatNum}`;

            return { row: rowLabel, seat: seatLabel };
        }

        function addSectionMarker(pos, label) {
            const markerGeo = new THREE.SphereGeometry(1.8, 16, 16);
            const markerMat = new THREE.MeshBasicMaterial({
                color: 0x2563eb,
                transparent: true,
                opacity: 0.7
            });
            const mesh = new THREE.Mesh(markerGeo, markerMat);
            mesh.position.copy(pos);
            mesh.isMarker = true;
            mesh.userData.label = label;
            state.scene.add(mesh);

            const div = document.createElement('div');
            div.className = 'marker-label';
            div.innerText = label;
            document.getElementById('label-container').appendChild(div);
            state.markers.push({ mesh, element: div });
        }

        // ========================================
        // INTERACTION HANDLERS
        // ========================================
        function onPointerMove(e) {
            state.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            state.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

            // Handle drag
            if (state.isDragging) {
                const dx = e.clientX - state.prevMouse.x;
                const dy = e.clientY - state.prevMouse.y;

                if (state.mode === 'orbital') {
                    state.orbit.lon -= dx * 0.25;
                    state.orbit.lat = Math.max(5, Math.min(85, state.orbit.lat + dy * 0.25));
                }
                state.prevMouse = { x: e.clientX, y: e.clientY };
                return;
            }

            state.raycaster.setFromCamera(state.mouse, state.camera);

            if (state.appMode === 'buy') {
                // Raycast to seats
                const intersects = state.raycaster.intersectObjects(state.meshes);
                const tooltip = document.getElementById('seat-tooltip');

                if (intersects.length > 0) {
                    const hit = intersects[0];
                    const mesh = hit.object;
                    const id = hit.instanceId;

                    // Highlight new seat
                    if (state.intersectedSeat.mesh !== mesh || state.intersectedSeat.index !== id) {
                        // Restore previous
                        if (state.intersectedSeat.mesh && state.intersectedSeat.mesh !== state.selectedSeat?.mesh) {
                            state.intersectedSeat.mesh.setColorAt(
                                state.intersectedSeat.index,
                                state.intersectedSeat.color
                            );
                            state.intersectedSeat.mesh.instanceColor.needsUpdate = true;
                        }

                        // Store and highlight new
                        state.intersectedSeat.mesh = mesh;
                        state.intersectedSeat.index = id;
                        mesh.getColorAt(id, state.intersectedSeat.color);

                        // Don't change color if it's the selected seat
                        if (!(state.selectedSeat?.mesh === mesh && state.selectedSeat?.index === id)) {
                            mesh.setColorAt(id, new THREE.Color(0xffffff));
                            mesh.instanceColor.needsUpdate = true;
                        }

                        // Update tooltip
                        const { rows, cols, tier } = mesh.userData;
                        const r = Math.floor(id / cols);
                        const c = id % cols;
                        const label = getSeatLabel(tier, r, c, rows, cols);

                        document.getElementById('tt-header').innerText = tier.name.toUpperCase();
                        document.getElementById('tt-label').innerText = `${label.row} - ${label.seat}`;
                        document.getElementById('tt-price').innerText = `${tier.price} ADA`;
                    }

                    tooltip.style.left = e.clientX + 'px';
                    tooltip.style.top = e.clientY + 'px';
                    tooltip.classList.add('visible');
                    document.body.style.cursor = 'pointer';
                } else {
                    // Clear hover
                    if (state.intersectedSeat.mesh) {
                        if (!(state.selectedSeat?.mesh === state.intersectedSeat.mesh &&
                              state.selectedSeat?.index === state.intersectedSeat.index)) {
                            state.intersectedSeat.mesh.setColorAt(
                                state.intersectedSeat.index,
                                state.intersectedSeat.color
                            );
                            state.intersectedSeat.mesh.instanceColor.needsUpdate = true;
                        }
                        state.intersectedSeat.mesh = null;
                    }
                    tooltip.classList.remove('visible');
                    document.body.style.cursor = 'default';
                }
            } else {
                // Design mode - raycast to markers
                const intersects = state.raycaster.intersectObjects(
                    state.scene.children.filter(o => o.isMarker)
                );
                state.markers.forEach(m => m.element.classList.remove('visible'));

                if (intersects.length > 0) {
                    const m = state.markers.find(x => x.mesh === intersects[0].object);
                    if (m) m.element.classList.add('visible');
                    document.body.style.cursor = 'pointer';
                } else {
                    document.body.style.cursor = 'default';
                }
            }
        }

        function onPointerDown(e) {
            // Only start drag if clicking on canvas area
            const sidebar = document.getElementById('sidebar');
            const sidebarWidth = sidebar.classList.contains('collapsed') ? 0 : 340;

            if (e.clientX > sidebarWidth || state.appMode === 'buy') {
                state.isDragging = true;
                state.prevMouse = { x: e.clientX, y: e.clientY };
            }
        }

        function onPointerUp(e) {
            const wasDragging = state.isDragging;
            const dragDistance = Math.hypot(
                e.clientX - state.prevMouse.x,
                e.clientY - state.prevMouse.y
            );
            state.isDragging = false;

            // Ignore if it was a drag, not a click
            if (wasDragging && dragDistance > 5) return;

            if (state.appMode === 'buy' && state.intersectedSeat.mesh) {
                selectSeat(state.intersectedSeat.mesh, state.intersectedSeat.index);
            } else if (state.appMode === 'design') {
                // Click on marker to switch to POV
                state.raycaster.setFromCamera(state.mouse, state.camera);
                const hits = state.raycaster.intersectObjects(
                    state.scene.children.filter(o => o.isMarker)
                );
                if (hits.length > 0) {
                    setViewMode('pov');
                    state.pov.pos.copy(hits[0].object.position);
                    state.pov.lookAt.set(0, state.stageHeight / 2, 0);
                    document.getElementById('location-label').innerText = hits[0].object.userData.label;
                }
            }
        }

        function selectSeat(mesh, id) {
            // Clear previous selection
            if (state.selectedSeat) {
                state.selectedSeat.mesh.setColorAt(
                    state.selectedSeat.index,
                    state.selectedSeat.originalColor
                );
                state.selectedSeat.mesh.instanceColor.needsUpdate = true;
            }

            const { rows, cols, tier } = mesh.userData;
            const r = Math.floor(id / cols);
            const c = id % cols;
            const label = getSeatLabel(tier, r, c, rows, cols);

            // Get seat position for POV
            const dummy = new THREE.Object3D();
            mesh.getMatrixAt(id, dummy.matrix);
            dummy.matrix.decompose(dummy.position, dummy.quaternion, dummy.scale);
            const seatPos = dummy.position.clone();
            const eyePos = seatPos.clone().add(new THREE.Vector3(0, 1.4, 0));

            // Switch to POV
            state.pov.pos.copy(eyePos);
            state.pov.lookAt.set(0, state.stageHeight / 2, 0);
            setViewMode('pov');

            // Highlight selected seat
            const originalColor = new THREE.Color();
            mesh.getColorAt(id, originalColor);
            mesh.setColorAt(id, new THREE.Color(0xfbbf24)); // Yellow highlight
            mesh.instanceColor.needsUpdate = true;
            state.selectedSeat = { mesh, index: id, originalColor };

            // Update UI
            const seatDetail = `${tier.name} - ${label.row} - ${label.seat}`;
            document.getElementById('location-label').innerText = seatDetail;
            document.getElementById('panel-seat-info').innerText = seatDetail.toUpperCase();
            document.getElementById('panel-seat-detail').innerText = seatDetail;
            document.getElementById('panel-price').innerText = `${tier.price} ADA`;
            document.getElementById('panel-total').innerText = `${tier.price + 2} ADA`;

            // Show buy panel
            document.getElementById('buy-panel').classList.add('visible');
        }

        function closeBuyPanel() {
            document.getElementById('buy-panel').classList.remove('visible');

            if (state.selectedSeat) {
                state.selectedSeat.mesh.setColorAt(
                    state.selectedSeat.index,
                    state.selectedSeat.originalColor
                );
                state.selectedSeat.mesh.instanceColor.needsUpdate = true;
                state.selectedSeat = null;
            }

            setViewMode('orbital');
            document.getElementById('location-label').innerText = state.appMode === 'buy'
                ? "Select a seat"
                : "Venue Designer";
        }

        // ========================================
        // ANIMATION LOOP
        // ========================================
        function animate() {
            requestAnimationFrame(animate);

            // Camera animation
            if (state.mode === 'orbital') {
                const phi = THREE.MathUtils.degToRad(90 - state.orbit.lat);
                const theta = THREE.MathUtils.degToRad(state.orbit.lon);
                const target = new THREE.Vector3().setFromSphericalCoords(
                    state.orbit.radius, phi, theta
                );
                state.camera.position.lerp(target, 0.08);
                state.camera.lookAt(0, state.stageHeight / 2, 0);
            } else {
                state.camera.position.lerp(state.pov.pos, 0.08);
                state.camera.lookAt(state.pov.lookAt);
            }

            // Update marker positions
            if (state.appMode === 'design') {
                state.markers.forEach(m => {
                    m.mesh.visible = true;
                    const v = m.mesh.position.clone().project(state.camera);
                    if (v.z < 1) {
                        m.element.style.display = 'block';
                        m.element.style.left = ((v.x * 0.5 + 0.5) * window.innerWidth) + "px";
                        m.element.style.top = ((-v.y * 0.5 + 0.5) * window.innerHeight) + "px";
                    } else {
                        m.element.style.display = 'none';
                    }
                });
            } else {
                state.markers.forEach(m => {
                    m.mesh.visible = false;
                    m.element.style.display = 'none';
                });
            }

            state.renderer.render(state.scene, state.camera);
        }

        // ========================================
        // MODE CONTROLS
        // ========================================
        function setAppMode(mode) {
            state.appMode = mode;

            // Toggle sidebar
            document.getElementById('sidebar').classList.toggle('collapsed', mode === 'buy');

            // Update tabs
            document.getElementById('tab-design').classList.toggle('active', mode === 'design');
            document.getElementById('tab-design').setAttribute('aria-pressed', mode === 'design');
            document.getElementById('tab-buy').classList.toggle('active', mode === 'buy');
            document.getElementById('tab-buy').setAttribute('aria-pressed', mode === 'buy');

            // Update status
            const statusLabel = document.getElementById('status-label');
            const statusDot = document.getElementById('status-dot');

            if (mode === 'buy') {
                statusLabel.innerText = "PREVIEW MODE";
                statusDot.className = "relative w-2.5 h-2.5 rounded-full bg-green-500 pulse-ring";
                closeBuyPanel();
                document.getElementById('location-label').innerText = "Select a seat";
            } else {
                statusLabel.innerText = "DESIGN MODE";
                statusDot.className = "relative w-2.5 h-2.5 rounded-full bg-blue-600";
                document.getElementById('location-label').innerText = "Venue Designer";
            }

            setViewMode('orbital');
        }

        function setViewMode(mode) {
            state.mode = mode;

            document.getElementById('view-orbit').classList.toggle('active', mode === 'orbital');
            document.getElementById('view-orbit').setAttribute('aria-pressed', mode === 'orbital');
            document.getElementById('view-pov').classList.toggle('active', mode === 'pov');
            document.getElementById('view-pov').setAttribute('aria-pressed', mode === 'pov');
        }

        // ========================================
        // SIDEBAR RENDERING
        // ========================================
        function renderSidebar() {
            renderTierList();
            renderObstructionList();
        }

        function renderTierList() {
            const tierList = document.getElementById('tier-list');
            tierList.innerHTML = '';

            state.tiers.forEach((tier, i) => {
                const unit = tier.layout === 'fanned' ? 'Â°' : 'm';
                const div = document.createElement('div');
                div.className = 'config-card';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-200">
                        <input
                            type="text"
                            value="${tier.name}"
                            class="text-input font-bold text-sm w-2/3"
                            aria-label="Section name"
                            onchange="state.tiers[${i}].name=this.value; refreshVenue()"
                        >
                        <button
                            onclick="state.tiers.splice(${i},1); refreshVenue(); renderSidebar()"
                            class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 transition"
                            aria-label="Remove section"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5">Layout</label>
                            <select
                                aria-label="Section layout"
                                onchange="state.tiers[${i}].layout=this.value; refreshVenue(); renderSidebar()"
                            >
                                <option value="fanned" ${tier.layout === 'fanned' ? 'selected' : ''}>Fanned</option>
                                <option value="rectangular" ${tier.layout === 'rectangular' ? 'selected' : ''}>Rectangular</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5">Price</label>
                            <div class="flex items-center border border-slate-200 rounded-lg px-3 bg-white focus-within:border-blue-600 focus-within:ring-2 focus-within:ring-blue-100 transition">
                                <span class="text-xs text-slate-400 font-semibold">ADA</span>
                                <input
                                    type="number"
                                    value="${tier.price}"
                                    class="w-full py-2.5 pl-2 text-sm font-bold outline-none bg-transparent"
                                    aria-label="Ticket price in ADA"
                                    onchange="state.tiers[${i}].price=parseInt(this.value)"
                                >
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2">
                                <span>Depth (Rows)</span>
                                <span id="depth-val-${i}" class="text-blue-600 tabular-nums">${tier.depth} m</span>
                            </div>
                            <input
                                type="range" min="10" max="80" value="${tier.depth}"
                                aria-label="Section depth"
                                oninput="state.tiers[${i}].depth=parseInt(this.value); document.getElementById('depth-val-${i}').innerText=this.value+' m'; refreshVenue()"
                            >
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2">
                                <span>Incline</span>
                                <span id="pitch-val-${i}" class="text-blue-600 tabular-nums">${(tier.pitch * 100).toFixed(0)}%</span>
                            </div>
                            <input
                                type="range" min="0" max="0.25" step="0.01" value="${tier.pitch}"
                                aria-label="Section incline"
                                oninput="state.tiers[${i}].pitch=parseFloat(this.value); document.getElementById('pitch-val-${i}').innerText=(this.value*100).toFixed(0)+'%'; refreshVenue()"
                            >
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2">
                                <span>Spread</span>
                                <span id="width-val-${i}" class="text-blue-600 tabular-nums">${tier.width}${unit}</span>
                            </div>
                            <input
                                type="range" min="20" max="240" value="${tier.width}"
                                aria-label="Section spread"
                                oninput="state.tiers[${i}].width=parseInt(this.value); const u=state.tiers[${i}].layout==='fanned'?'Â°':'m'; document.getElementById('width-val-${i}').innerText=this.value + u; refreshVenue()"
                            >
                        </div>
                    </div>
                `;
                tierList.appendChild(div);
            });
        }

        function renderObstructionList() {
            const obsList = document.getElementById('obstruction-list');
            obsList.innerHTML = '';

            state.obstructions.forEach((obs, j) => {
                const div = document.createElement('div');
                div.className = 'config-card';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-slate-200">
                        <span class="font-bold text-sm text-slate-700">Pillar ${j + 1}</span>
                        <button
                            onclick="state.obstructions.splice(${j},1); refreshVenue(); renderSidebar()"
                            class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 transition"
                            aria-label="Remove pillar"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2">
                                <span>X Position</span>
                                <span id="obs-x-val-${j}" class="text-blue-600 tabular-nums">${obs.x.toFixed(0)}m</span>
                            </div>
                            <input
                                type="range" min="-100" max="100" step="5" value="${obs.x}"
                                aria-label="Pillar X position"
                                oninput="state.obstructions[${j}].x=parseFloat(this.value); document.getElementById('obs-x-val-${j}').innerText=this.value.toFixed(0)+'m'; refreshVenue()"
                            >
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2">
                                <span>Z Position</span>
                                <span id="obs-z-val-${j}" class="text-blue-600 tabular-nums">${obs.z.toFixed(0)}m</span>
                            </div>
                            <input
                                type="range" min="0" max="300" step="5" value="${obs.z}"
                                aria-label="Pillar Z position"
                                oninput="state.obstructions[${j}].z=parseFloat(this.value); document.getElementById('obs-z-val-${j}').innerText=this.value.toFixed(0)+'m'; refreshVenue()"
                            >
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2">
                                <span>Radius</span>
                                <span id="obs-r-val-${j}" class="text-blue-600 tabular-nums">${obs.radius}m</span>
                            </div>
                            <input
                                type="range" min="1" max="10" value="${obs.radius}"
                                aria-label="Pillar radius"
                                oninput="state.obstructions[${j}].radius=parseInt(this.value); document.getElementById('obs-r-val-${j}').innerText=this.value+'m'; refreshVenue()"
                            >
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2">
                                <span>Height</span>
                                <span id="obs-h-val-${j}" class="text-blue-600 tabular-nums">${obs.height}m</span>
                            </div>
                            <input
                                type="range" min="10" max="60" value="${obs.height}"
                                aria-label="Pillar height"
                                oninput="state.obstructions[${j}].height=parseInt(this.value); document.getElementById('obs-h-val-${j}').innerText=this.value+'m'; refreshVenue()"
                            >
                        </div>
                    </div>
                `;
                obsList.appendChild(div);
            });

            updateObstructionListVisibility();
        }

        function updateObstructionListVisibility() {
            const noObsMsg = document.getElementById('no-obstructions');
            if (noObsMsg) {
                noObsMsg.style.display = state.obstructions.length === 0 ? 'block' : 'none';
            }
        }

        // ========================================
        // ACTIONS
        // ========================================
        function addTier() {
            const colors = [0x2563eb, 0x3b82f6, 0x60a5fa, 0x1d4ed8, 0x1e40af];
            state.tiers.push({
                id: Date.now(),
                name: "New Section",
                price: 50,
                depth: 20,
                width: 90,
                pitch: 0.1,
                color: colors[state.tiers.length % colors.length],
                layout: 'fanned'
            });
            refreshVenue();
            renderSidebar();
        }

        function addObstruction() {
            state.obstructions.push({ x: 0, z: 80, radius: 4, height: 30 });
            refreshVenue();
            renderSidebar();
        }

        function applyPreset(val) {
            const presets = {
                stadium: [
                    { id: Date.now(), name: "Lower Bowl", price: 150, depth: 40, width: 100, pitch: 0.06, color: 0x2563eb, layout: 'fanned' },
                    { id: Date.now() + 1, name: "Upper Bowl", price: 80, depth: 35, width: 140, pitch: 0.2, color: 0x3b82f6, layout: 'fanned' }
                ],
                club: [
                    { id: Date.now(), name: "Floor", price: 50, depth: 40, width: 60, pitch: 0, color: 0x2563eb, layout: 'rectangular' },
                    { id: Date.now() + 1, name: "VIP", price: 200, depth: 15, width: 60, pitch: 0.1, color: 0x1d4ed8, layout: 'rectangular' }
                ],
                amphitheater: [
                    { id: Date.now(), name: "Orchestra", price: 120, depth: 30, width: 80, pitch: 0.04, color: 0x2563eb, layout: 'rectangular' },
                    { id: Date.now() + 1, name: "Mezzanine", price: 65, depth: 25, width: 120, pitch: 0.12, color: 0x3b82f6, layout: 'fanned' }
                ]
            };

            state.tiers = presets[val] || presets.amphitheater;
            state.obstructions = [];
            refreshVenue();
            renderSidebar();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');

            const chevron = document.getElementById('chevron');
            chevron.style.transform = sidebar.classList.contains('collapsed')
                ? 'rotate(180deg)'
                : 'rotate(0deg)';
        }

        function exportConfig() {
            const config = {
                stageWidth: state.stageWidth,
                tiers: state.tiers,
                obstructions: state.obstructions
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'venue-config.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function mockMint() {
            // In production, this would connect to the wallet
            alert("Transaction constructed! In production, this would submit to your Cardano wallet for signing.");
        }

        function dismissHint() {
            document.getElementById('hint-overlay').classList.remove('visible');
            localStorage.setItem('seatmint-visited', 'true');
        }

        // ========================================
        // EVENT SETUP
        // ========================================
        function setupEvents() {
            // Pointer events
            window.addEventListener('pointermove', onPointerMove);
            window.addEventListener('pointerdown', onPointerDown);
            window.addEventListener('pointerup', onPointerUp);

            // Resize
            window.addEventListener('resize', () => {
                state.camera.aspect = window.innerWidth / window.innerHeight;
                state.camera.updateProjectionMatrix();
                state.renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // Wheel zoom
            window.addEventListener('wheel', (e) => {
                if (state.mode === 'orbital') {
                    state.orbit.radius = Math.max(50, Math.min(400, state.orbit.radius + e.deltaY * 0.3));
                }
            }, { passive: true });

            // Keyboard shortcuts
            window.addEventListener('keydown', (e) => {
                // Ignore if typing in input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

                switch (e.key.toLowerCase()) {
                    case 'd': setAppMode('design'); break;
                    case 'p': setAppMode('buy'); break;
                    case 'o': setViewMode('orbital'); break;
                    case 's': setViewMode('pov'); break;
                    case 'escape':
                        closeBuyPanel();
                        dismissHint();
                        break;
                }
            });
        }

        // ========================================
        // STARTUP
        // ========================================
        window.onload = init;
    </script>
</body>
</html>
